Android Gentoo Prefix – Session Log (2025-10-02)

Device + Connectivity
- Device: OnePlus9Pro, Android 15 (SDK 34), aarch64.
- LineageOS 22.2 reported by user.
- ADB over Wi‑Fi: new device at 192.168.1.107; initial port 40425, updated to 37021.
- Root: available via Magisk; note: some LineageOS builds deny chroot via SELinux without policy tweaks.

Filesystem Constraints
- `/sdcard` is FUSE, noexec and disallows symlinks.
- Executables must live under an exec-capable path, e.g. `/data/local/tmp`.
- Strategy: executables in `/data/local/tmp/run-bin`; bulk data in `/sdcard/gentoo`.

What Was Done
- Created `/sdcard/gentoo` and `/data/local/tmp/run-bin`.
- Pushed and verified static bash at `/data/local/tmp/run-bin/bash`.
- Verified `/sdcard` is noexec and symlink creation fails.
- Extracted Alpine minirootfs 3.15.0 to exec area: `/data/local/tmp/gentoo-run/alpine-rootfs`; extraction to `/sdcard/gentoo` hit link permission errors as expected.
- Tried to obtain static `proot` for aarch64; only x86_64 found in attempted URLs.
- Installed Android NDK r26b (host) at `toolchain-android/android-ndk-r26b` and validated simple aarch64 build/run on device.
- Fetched Gentoo Prefix bootstrap script to `/sdcard/gentoo/bootstrap-prefix.sh`; blocked pending a working native compiler in device PATH (ADB-only flow, no Termux).

Rationale/Decisions
- ADB-only is a hard constraint (no Termux runtime). All tooling must be pushed or cross-compiled on host.
- EPREFIX cannot reside purely on `/sdcard` due to noexec; maintain executables under `/data/local/tmp`, keep bulky data under `/sdcard/gentoo`.
- Rooted flow via chroot is possible but may require SELinux policy adjustments (non-persistent vs persistent approach documented in AGENTS.md).

Active Work (to resume on "continue")
1) Build native Android aarch64 toolchain on host via NDK r26b, then stage to device:
   - Binutils: host=`aarch64-linux-android`, target=`aarch64-linux-android`, built with NDK Clang/LLD and NDK sysroot.
   - GCC stage1 (C only): `--without-headers --disable-nls --disable-lto --disable-plugin --enable-languages=c` using NDK Clang as bootstrap.
   - Stage `{as,ld,ar,nm,ranlib,gcc}` to `/data/local/tmp/run-bin` and verify `gcc --version` on device.
   - Pull CRTs from NDK and Bionic shared libs from device if needed for runtime.
2) With native compiler available, re-run Prefix bootstrap:
   - Env: `PATH=/data/local/tmp/run-bin:$PATH`, `EPREFIX=/data/local/tmp/gprefix`, `DISTDIR=/sdcard/gentoo/distfiles`.
   - Run: `/data/local/tmp/run-bin/bash /sdcard/gentoo/bootstrap-prefix.sh /data/local/tmp/gprefix stage1`.

Reference Paths
- Static bash: `/data/local/tmp/run-bin/bash`
- Make: `/data/local/tmp/run-bin/make`
- Distfiles: `/sdcard/gentoo/distfiles`
- Logs: `/sdcard/gentoo/logs`
- NDK r26b (host): `toolchain-android/android-ndk-r26b`
- Alpine minirootfs archive in repo: `alpine-minirootfs-3.15.0-aarch64.tar.gz`

Open Items
- Known-good static `proot` for aarch64 Android (optional if we proceed with native toolchain + Prefix directly).
- SELinux chroot policy (optional, for rooted chroot flow; not needed if proot/native runs suffice).

How to Resume
- On host: resume binutils/GCC build under `builds/` with NDK r26b env, then push to device.
- On device: ensure `/data/local/tmp/run-bin` in PATH; rerun bootstrap as above.

Latest Update
- Added `scripts/adb-setup.sh` to automate ADB push and device prep:
  - Creates exec/tooling dirs under `/data/local/tmp` and data dirs under `/sdcard/gentoo`.
  - Pushes `bash-static-aarch64` as `/data/local/tmp/run-bin/bash` (verifies version).
  - Optionally pushes `proot.aarch64` and extracts `alpine-minirootfs-3.15.0-aarch64.tar.gz` to `/data/local/tmp/gentoo-run/alpine-rootfs`.
  - Verifies `/sdcard` noexec behavior.
- Current obstacle: device at `192.168.1.107:37021` not reachable at this moment; run the helper when ADB over Wi‑Fi is reconnected.
